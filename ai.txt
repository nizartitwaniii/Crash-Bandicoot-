local HttpService = game:GetService("HttpService")
local Players = game:GetService("Players")
local TweenService = game:GetService("TweenService")
local player = Players.LocalPlayer

local request = (syn and syn.request) or (http and http.request) or http_request or request
if not request then error("❌ لا توجد دالة HTTP متاحة.") end

-- 💬 واجهة الدردشة
local screenGui = Instance.new("ScreenGui", player:WaitForChild("PlayerGui"))
screenGui.Name = "GeminiChatUI"
screenGui.ResetOnSpawn = false
screenGui.IgnoreGuiInset = true

local mainFrame = Instance.new("Frame", screenGui)
mainFrame.Size = UDim2.new(0.85, 0, 0.65, 0)
mainFrame.AnchorPoint = Vector2.new(0.5, 0.5)
mainFrame.Position = UDim2.new(0.5, 0, 0.5, 0)
mainFrame.BackgroundColor3 = Color3.fromRGB(30, 30, 35)
mainFrame.BorderSizePixel = 0
mainFrame.ClipsDescendants = true
mainFrame.Visible = true

Instance.new("UICorner", mainFrame).CornerRadius = UDim.new(0, 12)

-- 🧭 زر إخفاء/إظهار
local toggleButton = Instance.new("TextButton", screenGui)
toggleButton.Size = UDim2.new(0, 50, 0, 50)
toggleButton.Position = UDim2.new(1, -60, 1, -60)
toggleButton.AnchorPoint = Vector2.new(0, 0)
toggleButton.Text = "🗨️"
toggleButton.TextSize = 24
toggleButton.BackgroundColor3 = Color3.fromRGB(0, 110, 255)
toggleButton.TextColor3 = Color3.new(1, 1, 1)
toggleButton.BorderSizePixel = 0
Instance.new("UICorner", toggleButton).CornerRadius = UDim.new(1, 0)

toggleButton.MouseButton1Click:Connect(function()
	mainFrame.Visible = not mainFrame.Visible
end)

-- 📝 الرسائل
local messageArea = Instance.new("ScrollingFrame", mainFrame)
messageArea.Size = UDim2.new(1, -20, 1, -80)
messageArea.Position = UDim2.new(0, 10, 0, 10)
messageArea.BackgroundColor3 = Color3.fromRGB(40, 40, 45)
messageArea.BorderSizePixel = 0
messageArea.AutomaticCanvasSize = Enum.AutomaticSize.Y
messageArea.CanvasSize = UDim2.new(0, 0, 0, 0)
messageArea.ScrollingDirection = Enum.ScrollingDirection.Y
messageArea.ScrollBarThickness = 6
messageArea.ClipsDescendants = true

local layout = Instance.new("UIListLayout", messageArea)
layout.SortOrder = Enum.SortOrder.LayoutOrder
layout.Padding = UDim.new(0, 6)

-- ✅ دالة إنشاء فقاعة رسالة
local function createMessageBubble(text, isUser)
	local bubble = Instance.new("TextLabel")
	bubble.Size = UDim2.new(1, -20, 0, 0)
	bubble.BackgroundColor3 = isUser and Color3.fromRGB(0, 110, 255) or Color3.fromRGB(55, 55, 65)
	bubble.TextColor3 = Color3.new(1, 1, 1)
	bubble.Font = Enum.Font.SourceSansSemibold
	bubble.TextSize = 18
	bubble.TextWrapped = true
	bubble.TextXAlignment = Enum.TextXAlignment.Left
	bubble.TextYAlignment = Enum.TextYAlignment.Top
	bubble.Text = text
	bubble.AutomaticSize = Enum.AutomaticSize.Y
	bubble.BorderSizePixel = 0
	bubble.BackgroundTransparency = 0.1
	bubble.ClipsDescendants = true

	Instance.new("UICorner", bubble).CornerRadius = UDim.new(0, 10)

	local padding = Instance.new("UIPadding", bubble)
	padding.PaddingLeft = UDim.new(0, 12)
	padding.PaddingRight = UDim.new(0, 12)
	padding.PaddingTop = UDim.new(0, 8)
	padding.PaddingBottom = UDim.new(0, 8)

	bubble.Parent = messageArea

	-- حركة بسيطة
	bubble.TextTransparency = 1
	local tween = TweenService:Create(bubble, TweenInfo.new(0.3), {TextTransparency = 0})
	tween:Play()

	task.wait()
	messageArea.CanvasPosition = Vector2.new(0, messageArea.AbsoluteCanvasSize.Y + 100)
end

-- 📥 إدخال المستخدم
local inputBox = Instance.new("TextBox", mainFrame)
inputBox.Size = UDim2.new(0.75, -15, 0, 40)
inputBox.Position = UDim2.new(0, 10, 1, -50)
inputBox.PlaceholderText = "اكتب رسالتك..."
inputBox.TextSize = 18
inputBox.BackgroundColor3 = Color3.fromRGB(50, 50, 55)
inputBox.TextColor3 = Color3.new(1, 1, 1)
inputBox.BorderSizePixel = 0
inputBox.Font = Enum.Font.SourceSans
Instance.new("UICorner", inputBox).CornerRadius = UDim.new(0, 10)

-- 📤 زر الإرسال
local sendButton = Instance.new("TextButton", mainFrame)
sendButton.Size = UDim2.new(0.25, -15, 0, 40)
sendButton.Position = UDim2.new(0.75, 5, 1, -50)
sendButton.Text = "إرسال"
sendButton.TextSize = 18
sendButton.BackgroundColor3 = Color3.fromRGB(0, 110, 255)
sendButton.TextColor3 = Color3.new(1, 1, 1)
sendButton.BorderSizePixel = 0
sendButton.Font = Enum.Font.SourceSansSemibold
Instance.new("UICorner", sendButton).CornerRadius = UDim.new(0, 10)

-- 🧠 المحادثة
local conversation = {}

-- 🚀 عند الضغط على زر الإرسال
sendButton.MouseButton1Click:Connect(function()
	local prompt = inputBox.Text
	if prompt == "" then return end

	createMessageBubble(prompt, true)
	table.insert(conversation, {
		role = "user",
		parts = {{ text = prompt }}
	})

	inputBox.Text = ""
	createMessageBubble("✍️ يكتب الآن...", false)

	local body = HttpService:JSONEncode({ contents = conversation })

	local success, result = pcall(function()
		return request({
			Url = "https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=AIzaSyAW8Ymo3CHFnbEsR7Nd1o0k7qhmiwBp78Q",
			Method = "POST",
			Headers = {["Content-Type"] = "application/json"},
			Body = body
		})
	end)

	messageArea:GetChildren()[#messageArea:GetChildren()]:Destroy() -- إزالة "يكتب الآن..."

	if not success then
		createMessageBubble("❌ فشل في الاتصال بـ API", false)
		warn(result)
		return
	end

	local data = HttpService:JSONDecode(result.Body)
	local reply = (data and data.candidates and data.candidates[1] and data.candidates[1].content and data.candidates[1].content.parts and data.candidates[1].content.parts[1].text) or "❌ لا يوجد رد"

	createMessageBubble(reply, false)

	table.insert(conversation, {
		role = "model",
		parts = {{ text = reply }}
	})
end)